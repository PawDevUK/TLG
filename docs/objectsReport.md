# TLG Project - Object Structures Report

## Overview

This document describes all major object structures used in the TLG (Timeline Generator) project, tracking their journey from GitHub API to OpenAI processing, database storage, and API endpoints.

---

## 1. Repository Object

### 1.1 Source: GitHub API Response

**Fetched from**: `app/api/gitHub/getUserRepoList/route.ts`

**GitHub API Endpoint**:

- Single repo: `https://api.github.com/repos/{user}/{repo}`
- All repos: `https://api.github.com/users/{user}/repos?per_page=100`

**Raw GitHub Structure**:

```typescript
{
  id: number;
  node_id: string;
  name: string;
  full_name: string;
  private: boolean;
  owner: {
    login: string;
    id: number;
  };
  html_url: string;
  url: string;
  created_at: string;
  updated_at: string;
  pushed_at: string;
  language: string;
  // ... other GitHub fields
}
```

### 1.2 Restructured for App Use

**Type Definition**: `types/repository.types.ts`

**App Structure**:

```typescript
export type Repository = {
  id: number;
  node_id: string;
  name: string;
  full_name: string;
  private: boolean;
  owner: {
    login: string;
    id: number;
  };
  html_url: string;
  url: string;
  created_at: string;
  updated_at: string;
  pushed_at: string;
  date: string;
  language: string;
  TLG: {                              // ← Custom app-specific field
    tracking: boolean;
    daysActiveCommits: string[];     // Array of dates with commits
    articles: {                        // Array of generated articles
      title: string;
      date: string;
      description: string;
      createdAt: Date;
    }[];
  };
};
```

**Key Transformation**:

- GitHub data is preserved as-is
- Added `TLG` object containing:
  - `tracking`: boolean flag for repository tracking status
  - `daysActiveCommits`: extracted from commit history
  - `articles`: generated by OpenAI from commits

### 1.3 Database Schema

**Schema Definition**: `lib/db/schema/repository.schema.ts`

```typescript
export const RepositorySchema: Schema<RepositoryDocument> = new Schema({
  id: { type: Number },
  node_id: { type: String },
  name: { type: String, required: true },
  full_name: { type: String },
  private: { type: Boolean, default: false },
  owner: {
    login: { type: String, required: true },
    id: { type: Number },
  },
  html_url: { type: String },
  url: { type: String },
  created_at: { type: String },
  updated_at: { type: String },
  pushed_at: { type: String },
  date: { type: String },
  language: { type: String },
  TLG: {
    tracking: { type: Boolean, default: false },
    daysActiveCommits: [{ type: String }],
    articles: [ArticleSchema],          // Embedded subdocument
  },
});
```

**Storage**: MongoDB via Mongoose

### 1.4 API Endpoints Usage

#### POST `/api/repositories`

**Purpose**: Create new repository with articles
**Process**:

1. Receives `{ user, repo }` in request body
2. Calls `createRepository()` which:
   - Fetches all commits from GitHub
   - Groups commits by date
   - Generates articles via OpenAI for each day
   - Creates Repository object with embedded articles
   - Saves to database via `AddRepository()`

#### GET `/api/repositories`

**Purpose**: Retrieve all repositories from database
**Returns**: Array of complete Repository objects with embedded articles
**Function**: `GetAllRepositories()`

#### GET `/api/timeline`

**Purpose**: Get combined timeline from all repositories
**Process**:

1. Fetches all repositories from DB
2. Calls `combineTimeLine()` to extract and sort articles
**Returns**: Flattened, sorted array of articles from all repositories

---

## 2. Commit Objects

### 2.1 Source: GitHub API Response

**Fetched from**:

- `app/api/gitHub/getRepoAllCommits/route.ts`
- `app/api/gitHub/getRepoDayCommits/route.ts`

**GitHub API Endpoint**:

```
https://api.github.com/repos/{user}/{repo}/commits
```

**Raw GitHub Commit Structure**:

```typescript
interface GitHubCommitApi {
  commit?: {
    author?: { 
      name?: string; 
      date?: string;    // ISO 8601 format
    };
    committer?: { 
      date?: string; 
    };
    message?: string;   // Full commit message
  };
  sha?: string;
  // ... other fields
}
```

### 2.2 Restructured for App Use

**Type Definition**: `types/commits.types.ts`

**Simplified Structure for Internal Use**:

```typescript
interface Commit {
  title: string;        // Repository name
  author?: string;      // Author name from commit
  date?: string;        // ISO date string
  description?: string; // Commit message
}
```

**Key Transformations**:

- Extracts `commit.author.name` → `author`
- Prioritizes `commit.author.date` over `commit.committer.date`
- Uses repository name as `title`
- Maps `commit.message` → `description`

### 2.3 Grouping by Date

**Location**: `lib/chatGPT/getRepoAllArticles.ts`, `lib/createRepository/createRepo.ts`

**Process**:

```typescript
// Group commits by date (YYYY-MM-DD)
const groups: Record<string, Commit[]> = {};
for (const c of commits) {
  if (!c.date) continue;
  const key = new Date(c.date).toISOString().slice(0, 10);  // Extract YYYY-MM-DD
  if (!groups[key]) groups[key] = [];
  groups[key].push(c);
}
```

**Result**: Object with date strings as keys, arrays of commits as values:

```typescript
{
  "2024-01-15": [commit1, commit2, ...],
  "2024-01-16": [commit3, commit4, ...],
  ...
}
```

### 2.4 Sent to OpenAI

**Location**: `lib/chatGPT/generateDayArticle.ts`

**Transformation for OpenAI**:
Commits are converted to bullet points:

```typescript
const bullets = commits.map((c, i) => {
  const timeStr = c.date ? new Date(c.date).toLocaleTimeString() : 'unknown time';
  return `${i + 1}. [${c.title}] ${c.description} (${c.author} - ${timeStr})`;
});
```

**Example Bullet**:

```
1. [TLG-Repo] Added user authentication with JWT tokens (john_doe - 10:30:45 AM)
2. [TLG-Repo] Fixed login validation bug (jane_smith - 2:15:30 PM)
```

**OpenAI Request Structure**:

```typescript
{
  model: 'gpt-3.5-turbo',
  messages: [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: getUserPrompt(repo, date, tone, length, bullets) }
  ],
  max_tokens: 800,
  temperature: 0.2
}
```

### 2.5 API Endpoints Usage

#### GET `/api/gitHub/getRepoAllCommits`

**Query Params**: `user`, `repo`, `maxPages` (optional)
**Returns**:

```typescript
{
  groups: Record<string, FlatCommit[]>,  // Commits grouped by date
  uniqueDays: number,                     // Number of unique days
  total: number,                          // Total commit count
  pagesFetched: number                    // Pages fetched from GitHub
}
```

#### GET `/api/gitHub/getRepoDayCommits`

**Query Params**: `user`, `repo`, `year`, `month`, `day`
**Returns**: Array of commits for specific day:

```typescript
[
  {
    title: "repo-name",
    author: "author-name",
    date: "2024-01-15T10:30:00Z",
    description: "commit message"
  },
  ...
]
```

---

## 3. Article Objects

### 3.1 Generated by OpenAI

**Location**: `lib/chatGPT/generateDayArticle.ts`

**OpenAI Response Format** (requested via system prompt):

```json
{
  "title": "string",
  "date": "string",
  "description": "string"
}
```

**System Prompt Requirements** (`lib/chatGPT/prompts.ts`):

- Output only valid JSON
- Title: repo name + concise topic (e.g., "TLG - Authentication Feature")
- Description: detailed paragraph summarizing changes
- Date: ISO date string (YYYY-MM-DD)
- No commentary outside JSON
- Ignore changes to articles.js, package-lock.json, ReadMe.md

**Example OpenAI Output**:

```json
{
  "title": "TLG - Authentication Improvements",
  "date": "2024-01-15",
  "description": "Enhanced user authentication system by adding JWT token-based authentication in the auth module. Updated login validation logic to handle edge cases with empty email fields. Modified the middleware.ts file to include token verification for protected routes. These changes improve security and user experience by providing persistent sessions and better error handling."
}
```

### 3.2 Restructured for App Use

**Type Definition**: `types/article.type.ts`

```typescript
export type ArticleType = {
  title: string;
  date: string;           // YYYY-MM-DD format
  description: string;    // AI-generated summary
  createdAt: Date;        // Timestamp when article was created
};
```

**Function**: `generateDayArticle()`
**Returns**:

```typescript
{
  title: string,
  date: string,
  description: string,
  createdAt: new Date()   // Added automatically
}
```

### 3.3 Database Schema

**Schema Definition**: `lib/db/schema/article.schema.ts`

```typescript
export const ArticleSchema: Schema<ArticleDocument> = new Schema({
  title: { type: String, required: true, unique: false },
  date: { type: String, required: true },
  description: { type: String, required: true },
  createdAt: { type: Date, default: Date.now },
});

// Pre-save hook: Capitalizes first letter of title
ArticleSchema.path('title').set(function (value: string) {
  return value.charAt(0).toUpperCase() + value.slice(1);
});
```

**Storage**:

- Embedded in Repository documents as subdocuments
- Can also be stored as standalone documents

### 3.4 API Endpoints Usage

#### GET `/api/repositories/articles`

**Purpose**: Get all standalone articles from database
**Returns**:

```typescript
{
  articles: ArticleType[]
}
```

#### POST `/api/repositories/articles`

**Purpose**: Create individual article manually
**Request Body**:

```typescript
{
  title: string;
  date: string;
  description: string;
}
```

#### GET `/api/repositories/articles/{id}`

**Purpose**: Get specific article by ID
**Returns**: Single article object

---

## 4. User Objects

### 4.1 Type Definition

**Location**: `types/user.type.ts`

```typescript
export type userTypes = {
  username: string;
  password: string;    // Hashed before storage
  email?: string;      // Optional
  createdAt: Date;
};
```

### 4.2 Database Schema

**Schema Definition**: `lib/db/schema/user.schema.ts`

```typescript
export const UserSchema: Schema<IUser> = new Schema({
  username: { type: String, required: true, unique: true },
  password: { type: String, required: true },
  email: { type: String, required: false, unique: true },
  createdAt: { type: Date, default: Date.now },
});
```

### 4.3 API Endpoints Usage

#### POST `/api/auth/register`

**Purpose**: Create new user account
**Process**: Hashes password before saving

#### POST `/api/auth/login`

**Purpose**: Authenticate user
**Returns**: JWT token for session

#### GET `/api/auth/user`

**Purpose**: Get current user information
**Requires**: Valid session token

---

## 5. Timeline Objects

### 5.1 Combined Timeline Structure

**Location**: `app/utils/combineTimeLine.ts`

**Extended Article Type**:

```typescript
type Article = {
  _id?: string;             // MongoDB ID
  title: string;
  date: string;
  description: string;
  createdAt?: Date;
  repositoryName?: string;   // Added for context
  repositoryUser?: string;   // Added for context
};
```

### 5.2 Combination Process

**Function**: `combineTimeLine(repositories: Repository[])`

**Process**:

1. Extract all articles from all repositories' `TLG.articles` arrays
2. Flatten into single array
3. Sort by date (newest first)

**Code**:

```typescript
const allArticles: Article[] = repositories.flatMap((repo: Repository) => {
  const articles = repo.TLG?.articles || [];
  return articles;
});

return allArticles.sort((a, b) => {
  const dateA = new Date(a.date).getTime();
  const dateB = new Date(b.date).getTime();
  return dateB - dateA;  // Newest first
});
```

### 5.3 API Endpoint Usage

#### GET `/api/timeline`

**Purpose**: Get unified timeline from all tracked repositories
**Process**:

1. Fetch all repositories from database
2. Combine articles using `combineTimeLine()`
3. Return sorted array

**Returns**: Array of articles sorted by date (newest → oldest)

---

## 6. Data Flow Summary

### Complete Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                         1. GITHUB API                                │
│                                                                       │
│  GET /repos/{user}/{repo}           → Repository metadata            │
│  GET /repos/{user}/{repo}/commits   → Commit history                 │
└────────────────────────┬────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    2. APP RESTRUCTURING                              │
│                                                                       │
│  ┌──────────────────────────────────────────────────────┐           │
│  │ getUserRepoList/route.ts                             │           │
│  │   • Fetches repo metadata                            │           │
│  │   • Adds TLG object with defaults                    │           │
│  │   • Returns Repository[] to client                   │           │
│  └──────────────────────────────────────────────────────┘           │
│                                                                       │
│  ┌──────────────────────────────────────────────────────┐           │
│  │ getRepoAllCommits/route.ts                           │           │
│  │   • Fetches all commits (paginated)                  │           │
│  │   • Extracts: title, author, date, description       │           │
│  │   • Groups by date: { "YYYY-MM-DD": Commit[] }       │           │
│  │   • Returns grouped commits                          │           │
│  └──────────────────────────────────────────────────────┘           │
└────────────────────────┬────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      3. OPENAI PROCESSING                            │
│                                                                       │
│  ┌──────────────────────────────────────────────────────┐           │
│  │ generateDayArticle.ts                                │           │
│  │   Input:  Commit[] for single day                    │           │
│  │                                                       │           │
│  │   Process:                                           │           │
│  │   1. Format commits as bullet points                 │           │
│  │   2. Send to OpenAI GPT-3.5-turbo with prompt        │           │
│  │   3. Parse JSON response                             │           │
│  │                                                       │           │
│  │   Output: {                                          │           │
│  │     title: "Repo - Summary",                         │           │
│  │     date: "YYYY-MM-DD",                              │           │
│  │     description: "AI-generated summary paragraph",   │           │
│  │     createdAt: Date                                  │           │
│  │   }                                                  │           │
│  └──────────────────────────────────────────────────────┘           │
│                                                                       │
│  ┌──────────────────────────────────────────────────────┐           │
│  │ getRepoAllArticles.ts                                │           │
│  │   • Fetches all commits for repo                     │           │
│  │   • Groups by date                                   │           │
│  │   • Calls generateDayArticle() for each date         │           │
│  │   • Returns ArticleType[]                            │           │
│  └──────────────────────────────────────────────────────┘           │
└────────────────────────┬────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      4. DATABASE STORAGE                             │
│                                                                       │
│  ┌──────────────────────────────────────────────────────┐           │
│  │ createRepo.ts                                        │           │
│  │   1. Fetch commits from GitHub                       │           │
│  │   2. Group by date                                   │           │
│  │   3. Generate articles via OpenAI                    │           │
│  │   4. Create Repository object:                       │           │
│  │      {                                               │           │
│  │        ...githubMetadata,                            │           │
│  │        TLG: {                                        │           │
│  │          tracking: true,                             │           │
│  │          daysActiveCommits: ["2024-01-15", ...],    │           │
│  │          articles: [ArticleType[], ...]              │           │
│  │        }                                             │           │
│  │      }                                               │           │
│  │   5. Save via AddRepository()                        │           │
│  └──────────────────────────────────────────────────────┘           │
│                                                                       │
│  MongoDB Collections:                                                │
│  • repositories (with embedded articles)                             │
│  • articles (standalone, optional)                                   │
│  • users                                                             │
└────────────────────────┬────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      5. API ENDPOINTS                                │
│                                                                       │
│  POST /api/repositories                                              │
│  ├─ Body: { user, repo }                                             │
│  ├─ Triggers: createRepository()                                     │
│  └─ Returns: 202 (processing started)                                │
│                                                                       │
│  GET /api/repositories                                               │
│  ├─ Fetches: All repositories from DB                                │
│  └─ Returns: Repository[] (with embedded articles)                   │
│                                                                       │
│  GET /api/timeline                                                   │
│  ├─ Fetches: All repositories                                        │
│  ├─ Process: combineTimeLine()                                       │
│  └─ Returns: Article[] (sorted by date, newest first)                │
│                                                                       │
│  GET /api/repositories/articles                                      │
│  └─ Returns: All standalone articles                                 │
│                                                                       │
│  GET /api/gitHub/*                                                   │
│  └─ Direct GitHub API proxy endpoints                                │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 7. Object Transformation Examples

### Example: Repository Creation Flow

#### Step 1: GitHub API Response

```json
{
  "id": 12345,
  "name": "my-awesome-project",
  "full_name": "username/my-awesome-project",
  "owner": {
    "login": "username",
    "id": 67890
  },
  "html_url": "https://github.com/username/my-awesome-project",
  "created_at": "2023-01-01T00:00:00Z",
  "language": "TypeScript"
}
```

#### Step 2: Commits Fetched and Grouped

```typescript
{
  "2024-01-15": [
    {
      title: "my-awesome-project",
      author: "john_doe",
      date: "2024-01-15T10:30:00Z",
      description: "Added authentication"
    },
    {
      title: "my-awesome-project",
      author: "jane_smith",
      date: "2024-01-15T14:20:00Z",
      description: "Fixed login bug"
    }
  ],
  "2024-01-16": [...]
}
```

#### Step 3: OpenAI Generates Articles

For each date group, OpenAI receives:

```
Create a JSON article following the schema.
Title hint: my-awesome-project. Date: 2024-01-15.

Commits:
1. [my-awesome-project] Added authentication (john_doe - 10:30:00 AM)
2. [my-awesome-project] Fixed login bug (jane_smith - 2:20:00 PM)
```

OpenAI returns:

```json
{
  "title": "my-awesome-project - Authentication Enhancements",
  "date": "2024-01-15",
  "description": "Implemented JWT-based authentication system and resolved critical login validation issue. The authentication module now supports secure token generation and verification. Fixed bug preventing users from logging in with empty email fields, improving user experience and system reliability."
}
```

#### Step 4: Saved to Database

```typescript
{
  id: 12345,
  name: "my-awesome-project",
  full_name: "username/my-awesome-project",
  owner: {
    login: "username",
    id: 67890
  },
  html_url: "https://github.com/username/my-awesome-project",
  created_at: "2023-01-01T00:00:00Z",
  language: "TypeScript",
  TLG: {
    tracking: true,
    daysActiveCommits: ["2024-01-15", "2024-01-16", ...],
    articles: [
      {
        title: "my-awesome-project - Authentication Enhancements",
        date: "2024-01-15",
        description: "Implemented JWT-based authentication system...",
        createdAt: "2024-01-20T08:00:00Z"
      },
      // ... more articles
    ]
  }
}
```

#### Step 5: Retrieved via API

```
GET /api/timeline
```

Returns combined, sorted articles from all repositories:

```json
[
  {
    "title": "my-awesome-project - Authentication Enhancements",
    "date": "2024-01-15",
    "description": "Implemented JWT-based authentication system...",
    "createdAt": "2024-01-20T08:00:00Z"
  },
  {
    "title": "another-project - Bug Fixes",
    "date": "2024-01-14",
    "description": "...",
    "createdAt": "2024-01-20T08:15:00Z"
  }
]
```

---

## 8. Key Transformation Points

### 8.1 GitHub → App (Repository)

- **What**: Add TLG custom field
- **Where**: `app/api/gitHub/getUserRepoList/route.ts`
- **Purpose**: Extend GitHub data with tracking metadata

### 8.2 GitHub → App (Commits)

- **What**: Simplify commit structure
- **Where**: `app/api/gitHub/getRepoAllCommits/route.ts`, `getRepoDayCommits/route.ts`
- **Transform**:
  - `commit.author.name` → `author`
  - `commit.message` → `description`
  - Repository name → `title`

### 8.3 Commits → OpenAI Request

- **What**: Format as bullet points
- **Where**: `lib/chatGPT/generateDayArticle.ts`
- **Purpose**: Create readable prompt for AI

### 8.4 OpenAI Response → Article

- **What**: Parse JSON, add timestamp
- **Where**: `lib/chatGPT/generateDayArticle.ts`
- **Add**: `createdAt: new Date()`

### 8.5 Articles → Repository Document

- **What**: Embed as subdocuments
- **Where**: `lib/createRepository/createRepo.ts`
- **Purpose**: Maintain relationship between repo and its articles

### 8.6 Repositories → Timeline

- **What**: Flatten and sort articles
- **Where**: `app/utils/combineTimeLine.ts`
- **Purpose**: Create unified chronological view

---

## 9. Database Operations

### 9.1 Create Operations

- **Repository**: `AddRepository()` in `lib/db/repository.db.ts`
- **Article**: `AddArticle()` in `lib/db/articles.db.ts`
- **User**: Via `/api/auth/register`

### 9.2 Read Operations

- **All Repositories**: `GetAllRepositories()`
- **Single Repository**: `GetRepository(id)`
- **All Articles**: `Get_DB_AllArticles()`
- **Single Article**: `GetArticle(id)`

### 9.3 Update Operations

- **Article**: `EditArticle(id, updates)`

### 9.4 Delete Operations

- **Article**: `DeleteArticle(id)`

---

## 10. Error Handling & Edge Cases

### 10.1 GitHub API Errors

- Rate limiting (403)
- Repository not found (404)
- Authentication failures (401)
- Network timeouts

### 10.2 OpenAI Processing Errors

- Rate limit exceeded
- Invalid API key
- Malformed JSON responses
- Fallback: Creates basic article from commit list

### 10.3 Database Errors

- Duplicate entries
- Connection failures
- Validation errors

---

## 11. Environment Variables

Required for full functionality:

- `GITHUB_TOKEN`: GitHub API authentication
- `CHATGPT_API`: OpenAI API key
- `MONGODB_URI`: Database connection string
- `NEXTAUTH_SECRET`: NextAuth authentication secret

---

## Conclusion

This TLG project implements a sophisticated pipeline that:

1. **Fetches** repository and commit data from GitHub
2. **Restructures** it into app-specific formats
3. **Processes** commits through OpenAI to generate meaningful summaries
4. **Stores** enriched data in MongoDB with embedded relationships
5. **Exposes** data through REST API endpoints for client consumption

The object transformations are carefully designed to preserve GitHub data integrity while adding value through AI-generated insights and organized timeline views.
